{% extends "base.html" %}

{% block vueapp %}
<v-app id="app">
    <v-snackbar v-model="snackbar" :bottom="y === 'bottom'" :left="x === 'left'" :multi-line="mode === 'multi-line'"
        :right="x === 'right'" :timeout="timeout" :top="y === 'top'" :vertical="mode === 'vertical'"
        :color="snackbar_color">
        [[ snackbar_text ]]
        <v-btn color="white" flat @click="snackbar = false">
            Close
        </v-btn>
    </v-snackbar>

    <template>
        <div>
            <v-toolbar flat color="white">
                {% if perms.auth.add_user %}
                <v-dialog v-model="dialog" scrollable max-width="600px">
                    <template v-slot:activator="{ on }">
                        <v-btn color="primary" dark class="mb-2" v-on="on">
                            <v-icon medium class="mr-2">add account_box
                            </v-icon>
                        </v-btn>
                    </template>
                    <v-card>
                        <v-card-title><span class="headline">Info Usuario</span></v-card-title>
                        <v-divider></v-divider>
                        <v-card-text style="height: 400px;">
                            <v-form method="post" id="userForm" v-model="valid" lazy-validation ref="form">
                                {% csrf_token %}
                                <v-container grid-list-md>
                                    <v-layout wrap>
                                        <v-flex xs12 sm6 md4>
                                            <v-text-field ref="txtusername" name="username" v-model="username"
                                                :counter="10" :rules="usernameRules" label="Usuario" required autofocus>
                                            </v-text-field>
                                        </v-flex>
                                        <v-flex xs12 sm6 md4>
                                            <v-text-field name="password" v-model="password" :rules="passwordRules"
                                                label="Contraseña" type="password" required></v-text-field>
                                        </v-flex>
                                        <v-flex xs12 sm6 md4>
                                            <v-text-field name="confirmpass" v-model="confirmpass"
                                                :rules="confirmpassRules" :error-messages='confirmPassword()'
                                                label="Confirmar Contraseña" type="password" required>
                                            </v-text-field>
                                        </v-flex>

                                        <v-flex xs12>
                                            <v-text-field name="email" v-model="email" :rules="emailRules"
                                                label="Correo" required></v-text-field>
                                        </v-flex>

                                        <v-flex xs12>
                                            <v-text-field name="first_name" v-model="first_name" :rules="firstNameRules"
                                                label="Nombres" required></v-text-field>
                                        </v-flex>
                                        <v-flex xs12>
                                            <v-text-field name="last_name" v-model="last_name" :rules="lastNameRules"
                                                label="Apellidos" required></v-text-field>
                                        </v-flex>
                                    </v-layout>
                                </v-container>
                            </v-form>
                        </v-card-text>
                        <v-divider></v-divider>
                        <v-card-actions>
                            <v-spacer></v-spacer>
                            <v-btn color="blue darken-1" flat @click="dialog = false">Cancelar</v-btn>
                            <v-btn color="blue darken-1" flat @click="resetForm">Limpiar</v-btn>
                            <v-btn color="blue darken-1" flat @click="saveUser" :disabled="!valid">Guardar
                            </v-btn>
                        </v-card-actions>
                    </v-card>
                </v-dialog>
                {% endif %}

                <v-toolbar-title>Lista Usuarios</v-toolbar-title>
                <v-divider class="mx-2" inset vertical></v-divider>
                <v-spacer></v-spacer>

                <v-dialog v-model="dialogEdit" scrollable max-width="600px">
                    <v-card>
                        <v-card-title><span class="headline">Editar Usuario</span></v-card-title>
                        <v-divider></v-divider>
                        <v-card-text style="height: 400px;">
                            <v-form method="post" id="userEditForm" v-model="valid" lazy-validation ref="editForm">
                                {% csrf_token %}
                                <v-container grid-list-md>
                                    <v-layout wrap>
                                        <v-flex xs12 sm6 md4>
                                            <v-text-field ref="txteditusername" name="editusername"
                                                v-model="editedItem.username" :counter="10" :rules="usernameRules"
                                                label="Usuario" required autofocus readonly>
                                            </v-text-field>
                                        </v-flex>
                                        <v-flex xs12>
                                            <v-text-field name="editemail" v-model="editedItem.email"
                                                :rules="emailRules" label="Correo" required></v-text-field>
                                        </v-flex>
                                        <v-flex xs12>
                                            <v-text-field name="editfirst_name" v-model="editedItem.first_name"
                                                :rules="firstNameRules" label="Nombres" required></v-text-field>
                                        </v-flex>
                                        <v-flex xs12>
                                            <v-text-field name="editlast_name" v-model="editedItem.last_name"
                                                :rules="lastNameRules" label="Apellidos" required></v-text-field>
                                        </v-flex>
                                        <v-flex xs12>
                                            <v-checkbox name="editis_active" v-model="editedItem.is_active"
                                                :label="`Activo: ${editedItem.is_active.toString()}`"></v-checkbox>
                                        </v-flex>
                                    </v-layout>
                                </v-container>
                            </v-form>
                        </v-card-text>
                        <v-divider></v-divider>
                        <v-card-actions>
                            <v-spacer></v-spacer>
                            <v-btn color="blue darken-1" flat @click="dialogEdit = false">Cancelar</v-btn>
                            <v-btn color="blue darken-1" flat @click="updateUser" :disabled="!valid">Guardar
                            </v-btn>
                        </v-card-actions>
                    </v-card>
                </v-dialog>

                <v-dialog v-model="dialogUserSettings" scrollable max-width="600px">
                    <v-card>
                        <v-toolbar color="black" dark>
                            <v-toolbar-title>Configurar Usuario</v-toolbar-title>
                            <v-text-field class="mx-3" flat label="Buscar Permiso" prepend-inner-icon="search"
                                solo-inverted v-model="searchPerm" clearable @click:clear="clearSearchPerm">
                            </v-text-field>
                        </v-toolbar>

                        <v-card-text style="height: 400px;">
                            <v-list two-line>
                                <template v-for="(perm, index) in filteredItems">
                                    <v-list-tile :key="perm.id" avatar ripple @click="changePerm(perm, editedItem)">
                                        <v-list-tile-content>
                                            <v-list-tile-title>[[ perm.codename ]]</v-list-tile-title>
                                        </v-list-tile-content>
                                        <v-list-tile-action>
                                            <v-icon v-if="!perm.chosen" color="grey lighten-1">
                                                star_border
                                            </v-icon>
                                            <v-icon v-else color="yellow darken-2">
                                                star
                                            </v-icon>
                                        </v-list-tile-action>
                                    </v-list-tile>
                                    <v-divider v-if="index + 1 < editedItem.available_permissions.length" :key="index">
                                    </v-divider>
                                </template>
                            </v-list>
                        </v-card-text>
                        <v-card-actions></v-card-actions>
                    </v-card>
                </v-dialog>
            </v-toolbar>
            <v-toolbar flat color="white">
                <v-flex xs12 sm6 md4>
                    <v-text-field v-model="search" prepend-inner-icon="search" label="Buscar" single-line hide-details
                        clearable>
                    </v-text-field>
                </v-flex>
            </v-toolbar>

            <v-data-table :headers="headers" :items="users" :search="search" class="elevation-1">
                <template v-slot:items="props">
                    <td>[[ props.item.id ]]</td>
                    <td class="text-xs-left">[[ props.item.username ]]</td>
                    <td class="text-xs-left">[[ props.item.email ]]</td>
                    <td class="text-xs-left">[[ props.item.first_name ]]</td>
                    <td class="text-xs-left">[[ props.item.last_name ]]</td>
                    <td class="text-xs-left">[[ props.item.is_active ]]</td>
                    <td class="justify-center layout px-0">
                        {% if perms.auth.change_user %}
                        <v-icon small class="mr-2" @click="editUserSettings(props.item)">settings</v-icon>
                        <v-icon small class="mr-2" @click="editUser(props.item)">edit</v-icon>
                        {% endif %}

                        {% if perms.auth.delete_user %}
                        <v-icon small @click="deleteUser(props.item)">delete</v-icon>
                        {% endif %}
                    </td>
                </template>
            </v-data-table>
        </div>
    </template>
</v-app>
{% endblock vueapp %}

{% block vuescript %}
<script>
    var app = new Vue({
        delimiters: ['[[', ']]'],
        el: '#app',
        data: {
            users: [],
            search: '',
            searchPerm: '',

            headers: [
                {
                    text: 'Id',
                    align: 'left',
                    value: 'id'
                },
                { text: 'Usuario', value: 'username' },
                { text: 'Correo', value: 'email' },
                { text: 'Nombres', value: 'first_name' },
                { text: 'Apellidos', value: 'last_name' },
                { text: 'Activo', value: 'is_active' },
                { text: 'Acciones', value: 'id', sorteable: false }
            ],

            snackbar: false,
            snackbar_text: '',
            snackbar_color: '',
            y: 'vertical',
            x: null,
            mode: '',
            timeout: 3000,

            dialog: false,
            dialogEdit: false,
            dialogUserSettings: false,
            valid: false,

            username: '',
            editusername: '',
            usernameRules: [
                (v) => !!v || 'Usuario es requerido',
                (v) => (v && v.length <= 10) || 'Usuario debe ser menos de 10 caracteres'
            ],

            password: '',
            passwordRules: [
                (v) => !!v || 'Contraseña es requerido'
            ],

            confirmpass: '',
            confirmpassRules: [
                (v) => !!v || 'Contraseña es requerido'
            ],

            email: '',
            editemail: '',
            emailRules: [
                (v) => /^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/.test(v) || 'Correo debe ser valido'
            ],

            first_name: '',
            editfirst_name: '',
            firstNameRules: [
                (v) => !!v || 'Nombre es requerido'
            ],

            last_name: '',
            editlast_name: '',
            lastNameRules: [
                (v) => !!v || 'Apellido es requerido'
            ],

            editedItem: {
                username: '',
                email: '',
                first_name: '',
                last_name: '',
                id: '',
                is_active: '',
                available_permissions: []
            },
        },

        computed: {
            filteredItems() {
                return this.editedItem.available_permissions.filter(item => {
                    if (!this.searchPerm) {
                        return this.editedItem.available_permissions;
                    }
                    else {
                        return (item.codename.toLowerCase().includes(this.searchPerm.toLowerCase()));
                    }
                });
            }
        },

        created: function () {
            this.getUsers();
            this.OnMessage();
        },

        methods: {
            confirmPassword() {
                return (this.password === this.confirmpass) ? '' : 'Contraseña no coincide'
            },

            resetForm() {
                this.$refs.form.reset();
                this.$refs.txtusername.focus();
            },

            getUsers() {
                axios.get(urlUsers).then(response => {
                    this.users = response.data;
                });
            },

            saveUser() {
                if (this.valid) {
                    const params = new URLSearchParams();
                    params.append('username', this.username);
                    params.append('password', this.password);
                    params.append('email', this.email);
                    params.append('first_name', this.first_name);
                    params.append('last_name', this.last_name);
                    params.append('is_active', false);

                    axios.post(urlUsers, params).then(response => {
                        this.dialog = false;
                        this.snackbar = true;
                        this.snackbar_text = 'Usuario creado : ' + response.data.username;
                        this.snackbar_color = 'success';

                        this.users.push(
                            {
                                'id': response.data.id,
                                'username': response.data.username,
                                'email': response.data.email,
                                'first_name': response.data.first_name,
                                'last_name': response.data.last_name,
                                'is_active': response.data.is_active,
                                'available_permissions': response.data.available_permissions
                            })

                        this.resetForm();
                        var message = "Usuario Agregado " + response.data.id;
                        this.OnSend(response, 'CREATE');

                    }).catch(error => {
                        this.snackbar = true;
                        this.snackbar_text = 'Status : ' + error.response.status + ' Message : ' + error.response.statusText + ' Text : ' + 'Usuario ya existe';
                        this.snackbar_color = 'error';
                    });
                }
            },

            deleteUser(item) {
                const index = this.users.indexOf(item);
                var result = confirm('Estas seguro de eliminar este elemento?');
                if (result) {
                    if (item != undefined) {
                        axios.delete(urlUsers + item.id + '/').then(response => {
                            this.users.splice(index, 1);
                            this.dialog = false;
                            this.snackbar = true;
                            this.snackbar_text = 'Usuario eliminado';
                            this.snackbar_color = 'success';
                            this.resetForm();
                            response = {
                                'data': {
                                    'id': item.id,
                                    'username': item.username
                                }
                            }
                            this.OnSend(response, 'DELETE');
                        }).catch(error => {
                            this.snackbar = true;
                            this.snackbar_text = 'Status : ' + error.response.status + ' Message : ' + error.response.statusText + ' Text : ' + 'Usuario ya existe';
                            this.snackbar_color = 'error';
                        });
                    }
                }
                else {
                    console.log('delete cancelled');
                }
            },

            editUser(item) {
                this.editedIndex = this.users.indexOf(item)
                this.editedItem = Object.assign({}, item)
                this.dialogEdit = true
            },

            updateUser() {
                const params = new URLSearchParams();
                params.append('username', this.editedItem.username);
                params.append('email', this.editedItem.email);
                params.append('first_name', this.editedItem.first_name);
                params.append('last_name', this.editedItem.last_name);
                params.append('is_active', this.editedItem.is_active);

                axios.patch(urlUsers + this.editedItem.id + '/', params).then(response => {
                    Object.assign(this.users[this.editedIndex], this.editedItem)
                    this.dialogEdit = false;
                    this.snackbar = true;
                    this.snackbar_text = 'Usuario actualizado';
                    this.snackbar_color = 'success';
                    this.OnSend(response, 'UPDATE');
                }).catch(error => {
                    this.snackbar = true;
                    this.snackbar_text = 'Status : ' + error.response.status + ' Message : ' + error.response.statusText + ' Text : ' + 'Usuario ya existe';
                    this.snackbar_color = 'error';
                });
            },

            /*USER SETTINGS*/
            clearSearchPerm() {
                this.searchPerm = "";
            },

            editUserSettings(item) {
                this.editedIndex = this.users.indexOf(item)
                this.editedItem = Object.assign({}, item)
                this.dialogUserSettings = true
            },

            changePerm(perm, user) {
                const params = new URLSearchParams();
                params.append('user_id', user.id);
                params.append('perm_id', perm.id);

                if (perm.chosen) {
                    axios.patch(urlUserPerms + user.id + '/', params).then(response => {
                        this.snackbar = true;
                        this.snackbar_text = 'Permiso modificado : ' + perm.codename;
                        this.snackbar_color = 'warning';
                        this.editedItem.available_permissions = response.data.available_permissions;
                        Object.assign(this.users[this.editedIndex], this.editedItem)
                        response.data['username'] = this.editedItem.username;
                        this.OnSend(response, 'UPDATE');
                    }).catch(error => {
                        this.snackbar = true;
                        this.snackbar_text = 'Status : ' + error.response.status + ' Message : ' + error.response.statusText + ' Text : ' + 'Error al modificar permiso';
                        this.snackbar_color = 'error';
                    });
                }
                else {
                    axios.post(urlUserPerms, params).then(response => {
                        this.snackbar = true;
                        this.snackbar_text = 'Permiso modificado : ' + perm.codename;
                        this.snackbar_color = 'success';
                        this.editedItem.available_permissions = response.data.available_permissions;
                        Object.assign(this.users[this.editedIndex], this.editedItem)
                        response.data['username'] = this.editedItem.username;
                        this.OnSend(response, 'UPDATE');
                    }).catch(error => {
                        this.snackbar = true;
                        this.snackbar_text = 'Status : ' + error.response.status + ' Message : ' + error.response.statusText + ' Text : ' + 'Error al modificar permiso';
                        this.snackbar_color = 'error';
                    });
                }
            },


            /*USER SOCKET*/
            OnSend(response, action) {
                if (appSocket.readyState) {
                    appSocket.send(JSON.stringify({
                        app_label: 'auth',
                        model_name: 'User',
                        instance: response.data.id,
                        username: response.data.username,
                        action_msg: action
                    }));
                }
                else {
                    alert('WebSocket No Se Pudo Conectar');
                }
            },

            OnMessage() {
                this.socket = appSocket;
                this.socket.onmessage = ({ data }) => {
                    let response = JSON.parse(data)['message'];
                    let action = JSON.parse(data)['action'];
                    response = JSON.parse(response);
                    let inArray = this.idInArray(response.id, this.users);

                    if (action === "CREATE" || action === "UPDATE") {
                        if (inArray === false) {
                            this.snackbar = true;
                            this.snackbar_text = "Agregarón al usuario " + response.username;
                            this.snackbar_color = 'info';
                            this.users.push({
                                'id': response.id,
                                'username': response.username,
                                'email': response.email,
                                'first_name': response.first_name,
                                'last_name': response.last_name,
                                'is_active': response.is_active,
                                'available_permissions': response.available_permissions
                            });
                        }
                        else {
                            if (action === "UPDATE") {
                                this.snackbar = true;
                                this.snackbar_text = "Actualizarón al usuario " + response.username;
                                this.snackbar_color = 'info';
                                Object.assign(this.users[inArray], {
                                    'id': response.id,
                                    'username': response.username,
                                    'email': response.email,
                                    'first_name': response.first_name,
                                    'last_name': response.last_name,
                                    'is_active': response.is_active,
                                    'available_permissions': response.available_permissions
                                });
                            }
                        }
                    }
                    else if (action === "DELETE") {
                        let inArray = this.idInArray(response.id, this.users)
                        if(!inArray === false){
                            console.log('remove from table');
                            this.users.splice(inArray, 1);
                            this.snackbar = true;
                            this.snackbar_color = 'error';
                            this.snackbar_text = response.msg + ' ' +response.username;
                        }
                    }
                    else {
                        console.log('ACCION NO PERMITIDA');
                    }
                };
            },

            idInArray: function (value, array) {
                for (var i = 0; i < array.length; i++) {
                    if (array[i].id == value) {
                        return i
                    }
                }
                return false
            }

        }
    })
</script>
{% endblock vuescript %}