<!DOCTYPE html>
<html lang="en">

<head>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.min.css" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

    <title>Home</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css"
        integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
</head>

<body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
        <a class="navbar-brand" href="/home/">Netcommtel</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar"
            aria-controls="navbarsExample04" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbar">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/home/">Home <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="/users/">Usuarios <span class="sr-only">(current)</span></a>
                </li>
            </ul>
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="/profile/">
                        <i class="fas fa-user-circle">
                            {{ request.user }}
                        </i>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/logout/">
                        <i class="fas fa-sign-out-alt">logout</i>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <v-app id="app">
        <v-snackbar v-model="snackbar" :bottom="y === 'bottom'" :left="x === 'left'" :multi-line="mode === 'multi-line'"
            :right="x === 'right'" :timeout="timeout" :top="y === 'top'" :vertical="mode === 'vertical'"
            :color="snackbar_color">
            [[ snackbar_text ]]
            <v-btn color="white" flat @click="snackbar = false">
                Close
            </v-btn>
        </v-snackbar>

        <template>
            <div>
                <v-toolbar flat color="white">
                    <v-toolbar-title>Lista Usuarios</v-toolbar-title>
                    <v-divider class="mx-2" inset vertical></v-divider>
                    <v-text-field v-model="search" append-icon="search" label="Buscar" single-line hide-details>
                    </v-text-field>
                    <v-spacer></v-spacer>
                    <v-dialog v-model="dialog" scrollable max-width="600px">
                        <template v-slot:activator="{ on }">
                            <v-btn color="primary" dark class="mb-2" v-on="on">Nuevo Usuario</v-btn>
                        </template>
                        <v-card>
                            <v-card-title><span class="headline">Info Usuario</span></v-card-title>
                            <v-divider></v-divider>
                            <v-card-text>
                                <v-form method="post" id="userForm" v-model="valid" lazy-validation ref="form">
                                    {% csrf_token %}
                                    <v-container grid-list-md>
                                        <v-layout wrap>
                                            <v-flex xs12 sm6 md4>
                                                <v-text-field ref="txtusername" name="username" v-model="username"
                                                    :counter="10" :rules="usernameRules" label="Usuario" required
                                                    autofocus>
                                                </v-text-field>
                                            </v-flex>
                                            <v-flex xs12 sm6 md4>
                                                <v-text-field name="password" v-model="password" :rules="passwordRules"
                                                    label="Contraseña" type="password" required></v-text-field>
                                            </v-flex>
                                            <v-flex xs12 sm6 md4>
                                                <v-text-field name="confirmpass" v-model="confirmpass"
                                                    :rules="confirmpassRules" :error-messages='confirmPassword()'
                                                    label="Confirmar Contraseña" type="password" required>
                                                </v-text-field>
                                            </v-flex>

                                            <v-flex xs12>
                                                <v-text-field name="email" v-model="email" :rules="emailRules"
                                                    label="Correo" required></v-text-field>
                                            </v-flex>

                                            <v-flex xs12>
                                                <v-text-field name="first_name" v-model="first_name"
                                                    :rules="firstNameRules" label="Nombres" required></v-text-field>
                                            </v-flex>
                                            <v-flex xs12>
                                                <v-text-field name="last_name" v-model="last_name"
                                                    :rules="lastNameRules" label="Apellidos" required></v-text-field>
                                            </v-flex>
                                        </v-layout>
                                    </v-container>
                                </v-form>
                            </v-card-text>
                            <v-divider></v-divider>
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn color="blue darken-1" flat @click="dialog = false">Cancelar</v-btn>
                                <v-btn color="blue darken-1" flat @click="resetForm">Limpiar</v-btn>
                                <v-btn color="blue darken-1" flat @click="saveUser" :disabled="!valid">Guardar
                                </v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>

                    <v-dialog v-model="dialogEdit" scrollable max-width="600px">
                        <v-card>
                            <v-card-title><span class="headline">Editar Usuario</span></v-card-title>
                            <v-divider></v-divider>
                            <v-card-text>
                                <v-form method="post" id="userEditForm" v-model="valid" lazy-validation ref="editForm">
                                    {% csrf_token %}
                                    <v-container grid-list-md>
                                        <v-layout wrap>
                                            <v-flex xs12 sm6 md4>
                                                <v-text-field ref="txteditusername" name="editusername"
                                                    v-model="editedItem.username" :counter="10" :rules="usernameRules"
                                                    label="Usuario" required autofocus readonly>
                                                </v-text-field>
                                            </v-flex>
                                            <v-flex xs12>
                                                <v-text-field name="editemail" v-model="editedItem.email"
                                                    :rules="emailRules" label="Correo" required></v-text-field>
                                            </v-flex>
                                            <v-flex xs12>
                                                <v-text-field name="editfirst_name" v-model="editedItem.first_name"
                                                    :rules="firstNameRules" label="Nombres" required></v-text-field>
                                            </v-flex>
                                            <v-flex xs12>
                                                <v-text-field name="editlast_name" v-model="editedItem.last_name"
                                                    :rules="lastNameRules" label="Apellidos" required></v-text-field>
                                            </v-flex>
                                            <v-flex xs12>
                                                <v-checkbox name="editis_active" v-model="editedItem.is_active"
                                                    :label="`Activo: ${editedItem.is_active.toString()}`"></v-checkbox>
                                            </v-flex>
                                        </v-layout>
                                    </v-container>
                                </v-form>
                            </v-card-text>
                            <v-divider></v-divider>
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn color="blue darken-1" flat @click="dialogEdit = false">Cancelar</v-btn>
                                <v-btn color="blue darken-1" flat @click="updateUser" :disabled="!valid">Guardar
                                </v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>

                </v-toolbar>

                <v-data-table :headers="headers" :items="users" :search="search" class="elevation-1">
                    <template v-slot:items="props">
                        <td>[[ props.item.id ]]</td>
                        <td class="text-xs-left">[[ props.item.username ]]</td>
                        <td class="text-xs-left">[[ props.item.email ]]</td>
                        <td class="text-xs-left">[[ props.item.first_name ]]</td>
                        <td class="text-xs-left">[[ props.item.last_name ]]</td>
                        <td class="text-xs-left">[[ props.item.is_active ]]</td>
                        <td class="justify-center layout px-0">
                            <v-icon small class="mr-2" @click="editUser(props.item)">edit</v-icon>
                            <v-icon small @click="deleteUser(props.item)">delete</v-icon>
                        </td>
                    </template>
                </v-data-table>
            </div>
        </template>
    </v-app>


    <script src="http://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.8/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>

    <script>
        var urlUsers = '/api/users/';
        axios.defaults.xsrfCookieName = 'csrftoken'
        axios.defaults.xsrfHeaderName = 'X-CSRFToken'

        var app = new Vue({
            delimiters: ['[[', ']]'],
            el: '#app',
            data: {
                users: [],
                search: '',

                headers: [
                    {
                        text: 'Id',
                        align: 'left',
                        value: 'id'
                    },
                    { text: 'Usuario', value: 'username' },
                    { text: 'Correo', value: 'email' },
                    { text: 'Nombres', value: 'first_name' },
                    { text: 'Apellidos', value: 'last_name' },
                    { text: 'Activo', value: 'is_active' },
                    { text: 'Acciones', value: 'id', sorteable: false }
                ],

                snackbar: false,
                snackbar_text: '',
                snackbar_color: '',
                y: 'vertical',
                x: null,
                mode: '',
                timeout: 3000,

                dialog: false,
                dialogEdit: false,
                valid: false,

                username: '',
                editusername: '',
                usernameRules: [
                    (v) => !!v || 'Usuario es requerido',
                    (v) => (v && v.length <= 10) || 'Usuario debe ser menos de 10 caracteres'
                ],

                password: '',
                passwordRules: [
                    (v) => !!v || 'Contraseña es requerido'
                ],

                confirmpass: '',
                confirmpassRules: [
                    (v) => !!v || 'Contraseña es requerido'
                ],

                email: '',
                editemail: '',
                emailRules: [
                    (v) => /^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/.test(v) || 'Correo debe ser valido'
                ],

                first_name: '',
                editfirst_name: '',
                firstNameRules: [
                    (v) => !!v || 'Nombre es requerido'
                ],

                last_name: '',
                editlast_name: '',
                lastNameRules: [
                    (v) => !!v || 'Apellido es requerido'
                ],

                editedItem: {
                    username: '',
                    email: '',
                    first_name: '',
                    last_name: '',
                    id: '',
                    is_active: ''
                },
            },
            created: function () {
                this.getUsers();
            },

            methods: {
                confirmPassword() {
                    return (this.password === this.confirmpass) ? '' : 'Contraseña no coincide'
                },

                resetForm() {
                    this.$refs.form.reset();
                    this.$refs.txtusername.focus();
                },

                getUsers() {
                    axios.get(urlUsers).then(response => {
                        this.users = response.data;
                    });
                },

                saveUser() {
                    if (this.valid) {
                        const params = new URLSearchParams();
                        params.append('username', this.username);
                        params.append('password', this.password);
                        params.append('email', this.email);
                        params.append('first_name', this.first_name);
                        params.append('last_name', this.last_name);
                        params.append('is_active', false);

                        axios.post(urlUsers, params).then(response => {
                            this.dialog = false;
                            this.snackbar = true;
                            this.snackbar_text = 'Usuario creado : ' + response.data.username;
                            this.snackbar_color = 'success';

                            this.users.push(
                                {
                                    'id': response.data.id,
                                    'username': response.data.username,
                                    'email': response.data.email,
                                    'first_name': response.data.first_name,
                                    'last_name': response.data.last_name,
                                    'is_active': response.data.is_active
                                })

                            this.resetForm();
                        }).catch(error => {
                            this.snackbar = true;
                            this.snackbar_text = 'Status : ' + error.response.status + ' Message : ' + error.response.statusText + ' Text : ' + 'Usuario ya existe';
                            this.snackbar_color = 'error';
                        });
                    }
                },

                deleteUser(item) {
                    const index = this.users.indexOf(item);
                    var result = confirm('Estas seguro de eliminar este elemento?');
                    if (result) {
                        if (item != undefined) {
                            axios.delete(urlUsers + item.id + '/').then(response => {
                                this.users.splice(index, 1);
                                this.dialog = false;
                                this.snackbar = true;
                                this.snackbar_text = 'Usuario eliminado';
                                this.snackbar_color = 'success';
                                this.resetForm();
                            }).catch(error => {
                                this.snackbar = true;
                                this.snackbar_text = 'Status : ' + error.response.status + ' Message : ' + error.response.statusText + ' Text : ' + 'Usuario ya existe';
                                this.snackbar_color = 'error';
                            });
                        }
                    }
                    else {
                        console.log('delete cancelled');
                    }
                },

                editUser(item) {
                    this.editedIndex = this.users.indexOf(item)
                    this.editedItem = Object.assign({}, item)
                    this.dialogEdit = true
                },

                updateUser() {
                    const params = new URLSearchParams();
                    params.append('username', this.editedItem.username);
                    params.append('email', this.editedItem.email);
                    params.append('first_name', this.editedItem.first_name);
                    params.append('last_name', this.editedItem.last_name);
                    params.append('is_active', this.editedItem.is_active);

                    axios.patch(urlUsers + this.editedItem.id + '/', params).then(response => {
                        Object.assign(this.users[this.editedIndex], this.editedItem)
                        this.dialogEdit = false;
                        this.snackbar = true;
                        this.snackbar_text = 'Usuario actualizado';
                        this.snackbar_color = 'success';
                    }).catch(error => {
                        this.snackbar = true;
                        this.snackbar_text = 'Status : ' + error.response.status + ' Message : ' + error.response.statusText + ' Text : ' + 'Usuario ya existe';
                        this.snackbar_color = 'error';
                    });
                }
            }
        })
    </script>
</body>

</html>